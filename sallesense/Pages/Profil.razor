@page "/profil"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using SallseSense.Services
@using SallseSense.Models
@using SallseSense.Authentication
@inject ProfilService ProfilService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Mon Profil - SalleSense</PageTitle>

<div class="container-fluid mt-4">
    @if (isLoading)
    {
        <div class="spinner-container">
            <div class="spinner spinner-lg"></div>
            <span class="spinner-text">Chargement de votre profil...</span>
        </div>
    }
    else if (utilisateur == null)
    {
        <div class="alert alert-modern alert-danger" role="alert">
            <span class="oi oi-warning me-2"></span>
            <strong>Erreur:</strong> Impossible de charger vos informations de profil.
        </div>
    }
    else
    {
        <!-- Messages de feedback -->
        @if (!string.IsNullOrEmpty(messageSucces))
        {
            <div class="alert alert-modern alert-success alert-dismissible fade show" role="alert">
                <span class="oi oi-check me-2"></span>
                @messageSucces
                <button type="button" class="btn-close" @onclick="@(() => messageSucces = string.Empty)"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(messageErreur))
        {
            <div class="alert alert-modern alert-danger alert-dismissible fade show" role="alert">
                <span class="oi oi-warning me-2"></span>
                @messageErreur
                <button type="button" class="btn-close" @onclick="@(() => messageErreur = string.Empty)"></button>
            </div>
        }

        <!-- En-tête du profil avec avatar -->
        <div class="profile-header mb-4">
            <div class="profile-header-content">
                <div class="profile-avatar">
                    <span class="profile-avatar-text">@GetInitials()</span>
                </div>
                <div class="profile-header-info">
                    <h1 class="profile-name">@utilisateur.Pseudo</h1>
                    <p class="profile-email">
                        <span class="oi oi-envelope-closed me-2"></span>
                        @utilisateur.Courriel
                    </p>
                    <div class="profile-badges">
                        @if (utilisateur.Role == "Admin")
                        {
                            <span class="badge badge-admin">
                                <span class="oi oi-star me-1"></span> Administrateur
                            </span>
                        }
                        else
                        {
                            <span class="badge badge-user">
                                <span class="oi oi-person me-1"></span> Utilisateur
                            </span>
                        }
                        <span class="badge badge-active">
                            <span class="oi oi-check me-1"></span> Compte actif
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Informations personnelles -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="oi oi-person me-2"></span>
                            Informations personnelles
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (!modeEdition)
                        {
                            <div class="profile-info-list">
                                <div class="profile-info-item">
                                    <div class="profile-info-icon">
                                        <span class="oi oi-person"></span>
                                    </div>
                                    <div class="profile-info-content">
                                        <span class="profile-info-label">Pseudo</span>
                                        <span class="profile-info-value">@utilisateur.Pseudo</span>
                                    </div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-icon">
                                        <span class="oi oi-envelope-closed"></span>
                                    </div>
                                    <div class="profile-info-content">
                                        <span class="profile-info-label">Adresse email</span>
                                        <span class="profile-info-value">@utilisateur.Courriel</span>
                                    </div>
                                </div>
                                <div class="profile-info-item">
                                    <div class="profile-info-icon">
                                        <span class="oi oi-badge"></span>
                                    </div>
                                    <div class="profile-info-content">
                                        <span class="profile-info-label">Rôle</span>
                                        <span class="profile-info-value">
                                            @if (utilisateur.Role == "Admin")
                                            {
                                                <span class="badge badge-admin">
                                                    <span class="oi oi-star me-1"></span> Administrateur
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-user">
                                                    <span class="oi oi-person me-1"></span> Utilisateur
                                                </span>
                                            }
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <button class="btn btn-primary" @onclick="ActiverModeEdition">
                                    <span class="oi oi-pencil me-2"></span>
                                    Modifier mes informations
                                </button>
                            </div>
                        }
                        else
                        {
                            <EditForm Model="@utilisateurEdit" OnValidSubmit="@SauvegarderModifications">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="alert alert-danger" />

                                <div class="mb-3">
                                    <label for="pseudo" class="form-label">
                                        <span class="oi oi-person me-1"></span> Pseudo <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <span class="oi oi-person"></span>
                                        </span>
                                        <InputText id="pseudo" class="form-control" @bind-Value="utilisateurEdit.Pseudo" placeholder="Votre pseudo" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="courriel" class="form-label">
                                        <span class="oi oi-envelope-closed me-1"></span> Email <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <span class="oi oi-envelope-closed"></span>
                                        </span>
                                        <InputText id="courriel" class="form-control" @bind-Value="utilisateurEdit.Courriel" type="email" placeholder="votre@email.com" />
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">
                                        <span class="oi oi-badge me-1"></span> Rôle
                                    </label>
                                    <div class="form-control-plaintext">
                                        @if (utilisateur.Role == "Admin")
                                        {
                                            <span class="badge badge-admin">
                                                <span class="oi oi-star me-1"></span> Administrateur
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-user">
                                                <span class="oi oi-person me-1"></span> Utilisateur
                                            </span>
                                        }
                                        <small class="text-muted ms-2">(Non modifiable)</small>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success @(isSubmitting ? "btn-loading" : "")" disabled="@isSubmitting">
                                        <span class="oi oi-check me-1"></span>
                                        Sauvegarder
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" @onclick="AnnulerEdition" disabled="@isSubmitting">
                                        <span class="oi oi-x me-1"></span>
                                        Annuler
                                    </button>
                                </div>
                            </EditForm>
                        }
                    </div>
                </div>
            </div>

            <!-- Sécurité - Mot de passe -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="oi oi-lock-locked me-2"></span>
                            Sécurité
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (!modeChangementMotDePasse)
                        {
                            <div class="security-info">
                                <div class="security-icon">
                                    <span class="oi oi-shield"></span>
                                </div>
                                <h6 class="security-title">Protection du compte</h6>
                                <p class="security-text">
                                    Pour des raisons de sécurité, nous vous recommandons de changer votre mot de passe régulièrement.
                                </p>
                                <ul class="security-tips">
                                    <li><span class="oi oi-check me-2 text-success"></span>Utilisez au moins 8 caractères</li>
                                    <li><span class="oi oi-check me-2 text-success"></span>Incluez des chiffres et symboles</li>
                                    <li><span class="oi oi-check me-2 text-success"></span>Évitez les mots courants</li>
                                </ul>
                                <button class="btn btn-warning" @onclick="@(() => modeChangementMotDePasse = true)">
                                    <span class="oi oi-key me-2"></span>
                                    Changer mon mot de passe
                                </button>
                            </div>
                        }
                        else
                        {
                            <EditForm Model="@motDePasseModel" OnValidSubmit="@ChangerMotDePasse">
                                <div class="mb-3">
                                    <label for="ancienMdp" class="form-label">
                                        <span class="oi oi-lock-locked me-1"></span> Ancien mot de passe <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <span class="oi oi-lock-locked"></span>
                                        </span>
                                        <InputText id="ancienMdp" class="form-control" @bind-Value="motDePasseModel.AncienMotDePasse" type="password" placeholder="Votre mot de passe actuel" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="nouveauMdp" class="form-label">
                                        <span class="oi oi-key me-1"></span> Nouveau mot de passe <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <span class="oi oi-key"></span>
                                        </span>
                                        <InputText id="nouveauMdp" class="form-control" @bind-Value="motDePasseModel.NouveauMotDePasse" type="password" placeholder="Nouveau mot de passe" />
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="confirmMdp" class="form-label">
                                        <span class="oi oi-check me-1"></span> Confirmer le mot de passe <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <span class="oi oi-check"></span>
                                        </span>
                                        <InputText id="confirmMdp" class="form-control" @bind-Value="motDePasseModel.ConfirmationMotDePasse" type="password" placeholder="Confirmez le nouveau mot de passe" />
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-warning @(isSubmittingPassword ? "btn-loading" : "")" disabled="@isSubmittingPassword">
                                        <span class="oi oi-check me-1"></span>
                                        Valider le changement
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" @onclick="AnnulerChangementMotDePasse" disabled="@isSubmittingPassword">
                                        <span class="oi oi-x me-1"></span>
                                        Annuler
                                    </button>
                                </div>
                            </EditForm>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private Utilisateur? utilisateur;
    private UtilisateurEditModel utilisateurEdit = new();
    private MotDePasseModel motDePasseModel = new();

    private bool isLoading = true;
    private bool modeEdition = false;
    private bool modeChangementMotDePasse = false;
    private bool isSubmitting = false;
    private bool isSubmittingPassword = false;

    private string messageSucces = string.Empty;
    private string messageErreur = string.Empty;

    private int userId;

    protected override async Task OnInitializedAsync()
    {
        await ChargerUtilisateur();
    }

    private string GetInitials()
    {
        if (utilisateur == null || string.IsNullOrEmpty(utilisateur.Pseudo))
            return "?";

        var parts = utilisateur.Pseudo.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return utilisateur.Pseudo.Length >= 2
            ? utilisateur.Pseudo.Substring(0, 2).ToUpper()
            : utilisateur.Pseudo.ToUpper();
    }

    private async Task ChargerUtilisateur()
    {
        isLoading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out userId))
                {
                    utilisateur = await ProfilService.GetUtilisateurAsync(userId);
                }
            }
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur lors du chargement: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ActiverModeEdition()
    {
        if (utilisateur != null)
        {
            utilisateurEdit = new UtilisateurEditModel
            {
                Pseudo = utilisateur.Pseudo,
                Courriel = utilisateur.Courriel
            };
            modeEdition = true;
            messageSucces = string.Empty;
            messageErreur = string.Empty;
        }
    }

    private void AnnulerEdition()
    {
        modeEdition = false;
        utilisateurEdit = new();
    }

    private async Task SauvegarderModifications()
    {
        isSubmitting = true;
        messageSucces = string.Empty;
        messageErreur = string.Empty;

        try
        {
            var result = await ProfilService.ModifierProfilAsync(userId, utilisateurEdit.Pseudo, utilisateurEdit.Courriel);

            if (result.Success)
            {
                await ChargerUtilisateur();
                modeEdition = false;
                messageSucces = result.Message;

                // Mettre à jour la session avec le nouveau pseudo
                var customAuth = (CustomAuthenticationStateProvider)AuthStateProvider;
                var newSession = new UserSession
                {
                    UserId = userId,
                    UserName = utilisateurEdit.Pseudo,
                    Role = utilisateur.Role ?? "User"
                };
                await customAuth.UpdateAuthenticationState(newSession);
            }
            else
            {
                messageErreur = result.Message;
            }
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void AnnulerChangementMotDePasse()
    {
        modeChangementMotDePasse = false;
        motDePasseModel = new();
    }

    private async Task ChangerMotDePasse()
    {
        isSubmittingPassword = true;
        messageSucces = string.Empty;
        messageErreur = string.Empty;

        try
        {
            var result = await ProfilService.ChangerMotDePasseAsync(
                userId,
                motDePasseModel.AncienMotDePasse,
                motDePasseModel.NouveauMotDePasse,
                motDePasseModel.ConfirmationMotDePasse);

            if (result.Success)
            {
                modeChangementMotDePasse = false;
                motDePasseModel = new();
                messageSucces = result.Message;
            }
            else
            {
                messageErreur = result.Message;
            }
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur: {ex.Message}";
        }
        finally
        {
            isSubmittingPassword = false;
        }
    }

    public class UtilisateurEditModel
    {
        public string Pseudo { get; set; } = string.Empty;
        public string Courriel { get; set; } = string.Empty;
    }

    public class MotDePasseModel
    {
        public string AncienMotDePasse { get; set; } = string.Empty;
        public string NouveauMotDePasse { get; set; } = string.Empty;
        public string ConfirmationMotDePasse { get; set; } = string.Empty;
    }
}
