@page "/profil"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<h3>Mon Profil</h3>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Chargement...</span>
        </div>
    </div>
}
else if (utilisateur == null)
{
    <div class="alert alert-danger">
        <strong>Erreur :</strong> Impossible de charger vos informations de profil.
    </div>
}
else
{
    @if (!string.IsNullOrEmpty(messageSucces))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @messageSucces
            <button type="button" class="close" @onclick="@(() => messageSucces = string.Empty)">
                <span>&times;</span>
            </button>
        </div>
    }

    @if (!string.IsNullOrEmpty(messageErreur))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @messageErreur
            <button type="button" class="close" @onclick="@(() => messageErreur = string.Empty)">
                <span>&times;</span>
            </button>
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Informations personnelles</h5>
                </div>
                <div class="card-body">
                    @if (!modeEdition)
                    {
                        <dl class="row">
                            <dt class="col-sm-4">Pseudo :</dt>
                            <dd class="col-sm-8">@utilisateur.Pseudo</dd>

                            <dt class="col-sm-4">Email :</dt>
                            <dd class="col-sm-8">@utilisateur.Courriel</dd>

                            <dt class="col-sm-4">Rôle :</dt>
                            <dd class="col-sm-8">
                                <span class="badge badge-@(utilisateur.Role == "Administrateur" ? "danger" : "primary")">
                                    @utilisateur.Role
                                </span>
                            </dd>
                        </dl>
                        <button class="btn btn-primary" @onclick="ActiverModeEdition">
                            Modifier mes informations
                        </button>
                    }
                    else
                    {
                        <EditForm Model="@utilisateurEdit" OnValidSubmit="@SauvegarderModifications">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="form-group">
                                <label for="pseudo">Pseudo :</label>
                                <InputText id="pseudo" class="form-control" @bind-Value="utilisateurEdit.Pseudo" />
                            </div>

                            <div class="form-group">
                                <label for="courriel">Email :</label>
                                <InputText id="courriel" class="form-control" @bind-Value="utilisateurEdit.Courriel" type="email" />
                            </div>

                            <div class="form-group">
                                <label>Rôle :</label>
                                <p class="form-control-plaintext">
                                    <span class="badge badge-@(utilisateur.Role == "Administrateur" ? "danger" : "primary")">
                                        @utilisateur.Role
                                    </span>
                                    <small class="text-muted ml-2">(Non modifiable)</small>
                                </p>
                            </div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-success" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                                    }
                                    Sauvegarder
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="AnnulerEdition" disabled="@isSubmitting">
                                    Annuler
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Changer le mot de passe</h5>
                </div>
                <div class="card-body">
                    @if (!modeChangementMotDePasse)
                    {
                        <p class="text-muted">Pour des raisons de sécurité, vous pouvez changer votre mot de passe à tout moment.</p>
                        <button class="btn btn-warning" @onclick="@(() => modeChangementMotDePasse = true)">
                            Changer mon mot de passe
                        </button>
                    }
                    else
                    {
                        <EditForm Model="@motDePasseModel" OnValidSubmit="@ChangerMotDePasse">
                            <div class="form-group">
                                <label for="ancienMdp">Ancien mot de passe :</label>
                                <InputText id="ancienMdp" class="form-control" @bind-Value="motDePasseModel.AncienMotDePasse" type="password" />
                            </div>

                            <div class="form-group">
                                <label for="nouveauMdp">Nouveau mot de passe :</label>
                                <InputText id="nouveauMdp" class="form-control" @bind-Value="motDePasseModel.NouveauMotDePasse" type="password" />
                            </div>

                            <div class="form-group">
                                <label for="confirmMdp">Confirmer le mot de passe :</label>
                                <InputText id="confirmMdp" class="form-control" @bind-Value="motDePasseModel.ConfirmationMotDePasse" type="password" />
                            </div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-warning" disabled="@isSubmittingPassword">
                                    @if (isSubmittingPassword)
                                    {
                                        <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                                    }
                                    Valider
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="AnnulerChangementMotDePasse" disabled="@isSubmittingPassword">
                                    Annuler
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
}
