@page "/profil"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using SallseSense.Services
@using SallseSense.Models
@inject ProfilService ProfilService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@attribute [Authorize]

<h3>Mon Profil</h3>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Chargement...</span>
        </div>
    </div>
}
else if (utilisateur == null)
{
    <div class="alert alert-danger">
        <strong>Erreur :</strong> Impossible de charger vos informations de profil.
    </div>
}
else
{
    @if (!string.IsNullOrEmpty(messageSucces))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @messageSucces
            <button type="button" class="close" @onclick="@(() => messageSucces = string.Empty)">
                <span>&times;</span>
            </button>
        </div>
    }

    @if (!string.IsNullOrEmpty(messageErreur))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @messageErreur
            <button type="button" class="close" @onclick="@(() => messageErreur = string.Empty)">
                <span>&times;</span>
            </button>
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Informations personnelles</h5>
                </div>
                <div class="card-body">
                    @if (!modeEdition)
                    {
                        <dl class="row">
                            <dt class="col-sm-4">Pseudo :</dt>
                            <dd class="col-sm-8">@utilisateur.Pseudo</dd>

                            <dt class="col-sm-4">Email :</dt>
                            <dd class="col-sm-8">@utilisateur.Courriel</dd>

                            <dt class="col-sm-4">Rôle :</dt>
                            <dd class="col-sm-8">
                                <span class="badge badge-@(utilisateur.Role == "Administrateur" ? "danger" : "primary")">
                                    @utilisateur.Role
                                </span>
                            </dd>
                        </dl>
                        <button class="btn btn-primary" @onclick="ActiverModeEdition">
                            Modifier mes informations
                        </button>
                    }
                    else
                    {
                        <EditForm Model="@utilisateurEdit" OnValidSubmit="@SauvegarderModifications">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="form-group">
                                <label for="pseudo">Pseudo :</label>
                                <InputText id="pseudo" class="form-control" @bind-Value="utilisateurEdit.Pseudo" />
                            </div>

                            <div class="form-group">
                                <label for="courriel">Email :</label>
                                <InputText id="courriel" class="form-control" @bind-Value="utilisateurEdit.Courriel" type="email" />
                            </div>

                            <div class="form-group">
                                <label>Rôle :</label>
                                <p class="form-control-plaintext">
                                    <span class="badge badge-@(utilisateur.Role == "Administrateur" ? "danger" : "primary")">
                                        @utilisateur.Role
                                    </span>
                                    <small class="text-muted ml-2">(Non modifiable)</small>
                                </p>
                            </div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-success" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                                    }
                                    Sauvegarder
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="AnnulerEdition" disabled="@isSubmitting">
                                    Annuler
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Changer le mot de passe</h5>
                </div>
                <div class="card-body">
                    @if (!modeChangementMotDePasse)
                    {
                        <p class="text-muted">Pour des raisons de sécurité, vous pouvez changer votre mot de passe à tout moment.</p>
                        <button class="btn btn-warning" @onclick="@(() => modeChangementMotDePasse = true)">
                            Changer mon mot de passe
                        </button>
                    }
                    else
                    {
                        <EditForm Model="@motDePasseModel" OnValidSubmit="@ChangerMotDePasse">
                            <div class="form-group">
                                <label for="ancienMdp">Ancien mot de passe :</label>
                                <InputText id="ancienMdp" class="form-control" @bind-Value="motDePasseModel.AncienMotDePasse" type="password" />
                            </div>

                            <div class="form-group">
                                <label for="nouveauMdp">Nouveau mot de passe :</label>
                                <InputText id="nouveauMdp" class="form-control" @bind-Value="motDePasseModel.NouveauMotDePasse" type="password" />
                            </div>

                            <div class="form-group">
                                <label for="confirmMdp">Confirmer le mot de passe :</label>
                                <InputText id="confirmMdp" class="form-control" @bind-Value="motDePasseModel.ConfirmationMotDePasse" type="password" />
                            </div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-warning" disabled="@isSubmittingPassword">
                                    @if (isSubmittingPassword)
                                    {
                                        <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                                    }
                                    Valider
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="AnnulerChangementMotDePasse" disabled="@isSubmittingPassword">
                                    Annuler
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private Utilisateur? utilisateur;
    private UtilisateurEditModel utilisateurEdit = new();
    private MotDePasseModel motDePasseModel = new();

    private bool isLoading = true;
    private bool modeEdition = false;
    private bool modeChangementMotDePasse = false;
    private bool isSubmitting = false;
    private bool isSubmittingPassword = false;

    private string messageSucces = string.Empty;
    private string messageErreur = string.Empty;

    private int userId;

    protected override async Task OnInitializedAsync()
    {
        await ChargerUtilisateur();
    }

    private async Task ChargerUtilisateur()
    {
        isLoading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out userId))
                {
                    utilisateur = await ProfilService.GetUtilisateurAsync(userId);
                }
            }
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur lors du chargement: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ActiverModeEdition()
    {
        if (utilisateur != null)
        {
            utilisateurEdit = new UtilisateurEditModel
            {
                Pseudo = utilisateur.Pseudo,
                Courriel = utilisateur.Courriel
            };
            modeEdition = true;
            messageSucces = string.Empty;
            messageErreur = string.Empty;
        }
    }

    private void AnnulerEdition()
    {
        modeEdition = false;
        utilisateurEdit = new();
    }

    private async Task SauvegarderModifications()
    {
        isSubmitting = true;
        messageSucces = string.Empty;
        messageErreur = string.Empty;

        try
        {
            var result = await ProfilService.ModifierProfilAsync(userId, utilisateurEdit.Pseudo, utilisateurEdit.Courriel);

            if (result.Success)
            {
                await ChargerUtilisateur();
                modeEdition = false;
                messageSucces = result.Message;
            }
            else
            {
                messageErreur = result.Message;
            }
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void AnnulerChangementMotDePasse()
    {
        modeChangementMotDePasse = false;
        motDePasseModel = new();
    }

    private async Task ChangerMotDePasse()
    {
        isSubmittingPassword = true;
        messageSucces = string.Empty;
        messageErreur = string.Empty;

        try
        {
            var result = await ProfilService.ChangerMotDePasseAsync(
                userId,
                motDePasseModel.AncienMotDePasse,
                motDePasseModel.NouveauMotDePasse,
                motDePasseModel.ConfirmationMotDePasse);

            if (result.Success)
            {
                modeChangementMotDePasse = false;
                motDePasseModel = new();
                messageSucces = result.Message;
            }
            else
            {
                messageErreur = result.Message;
            }
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur: {ex.Message}";
        }
        finally
        {
            isSubmittingPassword = false;
        }
    }

    public class UtilisateurEditModel
    {
        public string Pseudo { get; set; } = string.Empty;
        public string Courriel { get; set; } = string.Empty;
    }

    public class MotDePasseModel
    {
        public string AncienMotDePasse { get; set; } = string.Empty;
        public string NouveauMotDePasse { get; set; } = string.Empty;
        public string ConfirmationMotDePasse { get; set; } = string.Empty;
    }
}
