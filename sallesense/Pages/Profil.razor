@page "/profil"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using SallseSense.Models
@using SallseSense.Data
@attribute [Authorize]
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<Prog3A25BdSalleSenseContext> DbFactory
@inject NavigationManager NavigationManager

<h3>Mon Profil</h3>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Chargement...</span>
        </div>
    </div>
}
else if (utilisateur == null)
{
    <div class="alert alert-danger">
        <strong>Erreur :</strong> Impossible de charger vos informations de profil.
    </div>
}
else
{
    @if (!string.IsNullOrEmpty(messageSucces))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @messageSucces
            <button type="button" class="close" @onclick="@(() => messageSucces = string.Empty)">
                <span>&times;</span>
            </button>
        </div>
    }

    @if (!string.IsNullOrEmpty(messageErreur))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @messageErreur
            <button type="button" class="close" @onclick="@(() => messageErreur = string.Empty)">
                <span>&times;</span>
            </button>
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Informations personnelles</h5>
                </div>
                <div class="card-body">
                    @if (!modeEdition)
                    {
                        <dl class="row">
                            <dt class="col-sm-4">Pseudo :</dt>
                            <dd class="col-sm-8">@utilisateur.Pseudo</dd>

                            <dt class="col-sm-4">Email :</dt>
                            <dd class="col-sm-8">@utilisateur.Courriel</dd>

                            <dt class="col-sm-4">Rôle :</dt>
                            <dd class="col-sm-8">
                                <span class="badge badge-@(utilisateur.Role == "Administrateur" ? "danger" : "primary")">
                                    @utilisateur.Role
                                </span>
                            </dd>
                        </dl>
                        <button class="btn btn-primary" @onclick="ActiverModeEdition">
                            Modifier mes informations
                        </button>
                    }
                    else
                    {
                        <EditForm Model="@utilisateurEdit" OnValidSubmit="@SauvegarderModifications">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="form-group">
                                <label for="pseudo">Pseudo :</label>
                                <InputText id="pseudo" class="form-control" @bind-Value="utilisateurEdit.Pseudo" />
                            </div>

                            <div class="form-group">
                                <label for="courriel">Email :</label>
                                <InputText id="courriel" class="form-control" @bind-Value="utilisateurEdit.Courriel" type="email" />
                            </div>

                            <div class="form-group">
                                <label>Rôle :</label>
                                <p class="form-control-plaintext">
                                    <span class="badge badge-@(utilisateur.Role == "Administrateur" ? "danger" : "primary")">
                                        @utilisateur.Role
                                    </span>
                                    <small class="text-muted ml-2">(Non modifiable)</small>
                                </p>
                            </div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-success" disabled="@isSubmitting">
                                    @if (isSubmitting)
                                    {
                                        <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                                    }
                                    Sauvegarder
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="AnnulerEdition" disabled="@isSubmitting">
                                    Annuler
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Changer le mot de passe</h5>
                </div>
                <div class="card-body">
                    @if (!modeChangementMotDePasse)
                    {
                        <p class="text-muted">Pour des raisons de sécurité, vous pouvez changer votre mot de passe à tout moment.</p>
                        <button class="btn btn-warning" @onclick="@(() => modeChangementMotDePasse = true)">
                            Changer mon mot de passe
                        </button>
                    }
                    else
                    {
                        <EditForm Model="@motDePasseModel" OnValidSubmit="@ChangerMotDePasse">
                            <div class="form-group">
                                <label for="ancienMdp">Ancien mot de passe :</label>
                                <InputText id="ancienMdp" class="form-control" @bind-Value="motDePasseModel.AncienMotDePasse" type="password" />
                            </div>

                            <div class="form-group">
                                <label for="nouveauMdp">Nouveau mot de passe :</label>
                                <InputText id="nouveauMdp" class="form-control" @bind-Value="motDePasseModel.NouveauMotDePasse" type="password" />
                            </div>

                            <div class="form-group">
                                <label for="confirmMdp">Confirmer le mot de passe :</label>
                                <InputText id="confirmMdp" class="form-control" @bind-Value="motDePasseModel.ConfirmationMotDePasse" type="password" />
                            </div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-warning" disabled="@isSubmittingPassword">
                                    @if (isSubmittingPassword)
                                    {
                                        <span class="spinner-border spinner-border-sm mr-1" role="status"></span>
                                    }
                                    Valider
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="AnnulerChangementMotDePasse" disabled="@isSubmittingPassword">
                                    Annuler
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private Utilisateur? utilisateur;
    private UtilisateurEditModel utilisateurEdit = new();
    private MotDePasseModel motDePasseModel = new();

    private bool isLoading = true;
    private bool modeEdition = false;
    private bool modeChangementMotDePasse = false;
    private bool isSubmitting = false;
    private bool isSubmittingPassword = false;

    private string messageSucces = string.Empty;
    private string messageErreur = string.Empty;

    private int userId;

    protected override async Task OnInitializedAsync()
    {
        await ChargerUtilisateur();
    }

    private async Task ChargerUtilisateur()
    {
        isLoading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out userId))
                {
                    await using var db = await DbFactory.CreateDbContextAsync();
                    utilisateur = await db.Utilisateurs
                        .FirstOrDefaultAsync(u => u.IdUtilisateurPk == userId);
                }
            }
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur lors du chargement: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ActiverModeEdition()
    {
        if (utilisateur != null)
        {
            utilisateurEdit = new UtilisateurEditModel
            {
                Pseudo = utilisateur.Pseudo,
                Courriel = utilisateur.Courriel
            };
            modeEdition = true;
            messageSucces = string.Empty;
            messageErreur = string.Empty;
        }
    }

    private void AnnulerEdition()
    {
        modeEdition = false;
        utilisateurEdit = new();
    }

    private async Task SauvegarderModifications()
    {
        isSubmitting = true;
        messageSucces = string.Empty;
        messageErreur = string.Empty;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            // Paramètres pour la procédure stockée
            var pIdUtilisateur = new Microsoft.Data.SqlClient.SqlParameter("@IdUtilisateur", System.Data.SqlDbType.Int)
            {
                Value = userId
            };

            var pNouveauPseudo = new Microsoft.Data.SqlClient.SqlParameter("@NouveauPseudo", System.Data.SqlDbType.NVarChar, 40)
            {
                Value = utilisateurEdit.Pseudo
            };

            var pNouveauCourriel = new Microsoft.Data.SqlClient.SqlParameter("@NouveauCourriel", System.Data.SqlDbType.NVarChar, 40)
            {
                Value = utilisateurEdit.Courriel
            };

            var pCodeStatut = new Microsoft.Data.SqlClient.SqlParameter("@CodeStatut", System.Data.SqlDbType.Int)
            {
                Direction = System.Data.ParameterDirection.Output
            };

            // Exécuter la procédure stockée
            await db.Database.ExecuteSqlRawAsync(
                "EXEC dbo.usp_Utilisateur_Modifier @IdUtilisateur, @NouveauPseudo, @NouveauCourriel, @CodeStatut OUTPUT",
                pIdUtilisateur, pNouveauPseudo, pNouveauCourriel, pCodeStatut);

            // Récupérer le code de retour
            int codeStatut = pCodeStatut.Value != DBNull.Value ? (int)pCodeStatut.Value : -99;

            // Interpréter le résultat
            switch (codeStatut)
            {
                case 0:
                    // Recharger les données
                    await ChargerUtilisateur();
                    modeEdition = false;
                    messageSucces = "Vos informations ont été mises à jour avec succès!";
                    break;
                case -1:
                    messageErreur = "Utilisateur introuvable.";
                    break;
                case -2:
                    messageErreur = "Ce pseudo est déjà utilisé par un autre utilisateur.";
                    break;
                case -3:
                    messageErreur = "Cet email est déjà utilisé par un autre utilisateur.";
                    break;
                case -99:
                    messageErreur = "Erreur système lors de la modification.";
                    break;
                default:
                    messageErreur = "Erreur inconnue.";
                    break;
            }
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur lors de la sauvegarde: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void AnnulerChangementMotDePasse()
    {
        modeChangementMotDePasse = false;
        motDePasseModel = new();
    }

    private async Task ChangerMotDePasse()
    {
        isSubmittingPassword = true;
        messageSucces = string.Empty;
        messageErreur = string.Empty;

        try
        {
            // Validation
            if (string.IsNullOrWhiteSpace(motDePasseModel.AncienMotDePasse))
            {
                messageErreur = "Veuillez entrer votre ancien mot de passe.";
                return;
            }

            if (string.IsNullOrWhiteSpace(motDePasseModel.NouveauMotDePasse))
            {
                messageErreur = "Veuillez entrer un nouveau mot de passe.";
                return;
            }

            if (motDePasseModel.NouveauMotDePasse != motDePasseModel.ConfirmationMotDePasse)
            {
                messageErreur = "Les mots de passe ne correspondent pas.";
                return;
            }

            if (motDePasseModel.NouveauMotDePasse.Length < 6)
            {
                messageErreur = "Le mot de passe doit contenir au moins 6 caractères.";
                return;
            }

            await using var db = await DbFactory.CreateDbContextAsync();

            // Générer nouveau salt et calculer le hash (comme Reset_Password_Admin_Correct.sql)
            var nouveauSaltBytes = new byte[16];
            using (var rng = System.Security.Cryptography.RandomNumberGenerator.Create())
            {
                rng.GetBytes(nouveauSaltBytes);
            }

            var nouveauHashBytes = await db.Database.SqlQueryRaw<byte[]>(
                @"SELECT HASHBYTES('SHA2_256', {0} + CONVERT(VARBINARY(4000), {1})) AS Value",
                nouveauSaltBytes,
                motDePasseModel.NouveauMotDePasse
            ).FirstOrDefaultAsync();

            if (nouveauHashBytes == null || nouveauHashBytes.Length == 0)
            {
                messageErreur = "Erreur lors du calcul du hash du mot de passe.";
                return;
            }

            // Paramètres pour la procédure stockée
            var pIdUtilisateur = new Microsoft.Data.SqlClient.SqlParameter("@IdUtilisateur", System.Data.SqlDbType.Int)
            {
                Value = userId
            };

            var pAncienMotDePasse = new Microsoft.Data.SqlClient.SqlParameter("@AncienMotDePasse", System.Data.SqlDbType.NVarChar, -1)
            {
                Value = motDePasseModel.AncienMotDePasse
            };

            var pNouveauSalt = new Microsoft.Data.SqlClient.SqlParameter("@NouveauSalt", System.Data.SqlDbType.VarBinary, 16)
            {
                Value = nouveauSaltBytes
            };

            var pNouveauHash = new Microsoft.Data.SqlClient.SqlParameter("@NouveauHash", System.Data.SqlDbType.VarBinary, 32)
            {
                Value = nouveauHashBytes
            };

            var pCodeStatut = new Microsoft.Data.SqlClient.SqlParameter("@CodeStatut", System.Data.SqlDbType.Int)
            {
                Direction = System.Data.ParameterDirection.Output
            };

            // Exécuter la procédure stockée
            await db.Database.ExecuteSqlRawAsync(
                "EXEC dbo.usp_Utilisateur_ChangerMotDePasse @IdUtilisateur, @AncienMotDePasse, @NouveauSalt, @NouveauHash, @CodeStatut OUTPUT",
                pIdUtilisateur, pAncienMotDePasse, pNouveauSalt, pNouveauHash, pCodeStatut);

            // Récupérer le code de retour
            int codeStatut = pCodeStatut.Value != DBNull.Value ? (int)pCodeStatut.Value : -99;

            // Interpréter le résultat
            switch (codeStatut)
            {
                case 0:
                    modeChangementMotDePasse = false;
                    motDePasseModel = new();
                    messageSucces = "Votre mot de passe a été changé avec succès!";
                    break;
                case -1:
                    messageErreur = "Utilisateur introuvable.";
                    break;
                case -2:
                    messageErreur = "L'ancien mot de passe est incorrect.";
                    break;
                case -99:
                    messageErreur = "Erreur système lors du changement de mot de passe.";
                    break;
                default:
                    messageErreur = "Erreur inconnue.";
                    break;
            }
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur lors du changement de mot de passe: {ex.Message}";
        }
        finally
        {
            isSubmittingPassword = false;
        }
    }

    // Modèles pour les formulaires
    public class UtilisateurEditModel
    {
        public string Pseudo { get; set; } = string.Empty;
        public string Courriel { get; set; } = string.Empty;
    }

    public class MotDePasseModel
    {
        public string AncienMotDePasse { get; set; } = string.Empty;
        public string NouveauMotDePasse { get; set; } = string.Empty;
        public string ConfirmationMotDePasse { get; set; } = string.Empty;
    }
}
