@page "/photos"
@using SallseSense.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Logging
@attribute [Authorize]
@inject PhotoService PhotoService
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<Photos> Logger

<PageTitle>Photos - SalleSense</PageTitle>

<div class="container-fluid mt-4">
    <!-- En-tête moderne -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="page-title">
                        <span class="oi oi-camera-slr me-2" aria-hidden="true"></span>
                        Galerie de Photos
                    </h1>
                    <p class="page-subtitle">Photos capturées par les caméras dans les salles</p>
                </div>
                @if (!isLoading && photos != null && photos.Any())
                {
                    <div class="d-flex align-items-center gap-3">
                        <div class="photos-counter">
                            <span class="oi oi-image"></span>
                            <span class="photos-counter-value">@filteredPhotos.Count</span>
                            <span class="photos-counter-label">photo(s)</span>
                        </div>
                        <button class="btn btn-outline-primary @(isRefreshing ? "btn-loading" : "")"
                                @onclick="RefreshPhotos"
                                disabled="@isRefreshing">
                            <span class="oi oi-reload" aria-hidden="true"></span> Actualiser
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="spinner-container">
            <div class="spinner spinner-lg"></div>
            <span class="spinner-text">Chargement des photos...</span>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-modern alert-danger" role="alert">
            <span class="oi oi-warning me-2"></span>
            <strong>Erreur:</strong> @errorMessage
        </div>
    }
    else if (photos == null || !photos.Any())
    {
        <div class="empty-state">
            <div class="empty-state-icon">
                <span class="oi oi-camera-slr"></span>
            </div>
            <div class="empty-state-title">Aucune photo disponible</div>
            <p class="empty-state-text">Aucune photo n'a encore été capturée par les caméras.</p>
        </div>
    }
    else
    {
        <!-- Filtres inline modernes -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="filter-grid">
                            <div class="filter-item">
                                <label class="filter-label">
                                    <span class="oi oi-list me-1"></span> Filtrer par salle
                                </label>
                                <select class="form-select" @onchange="OnSalleFilterChanged">
                                    <option value="0">Toutes les salles</option>
                                    @foreach (var salle in salles)
                                    {
                                        <option value="@salle">Salle @salle</option>
                                    }
                                </select>
                            </div>
                            <div class="filter-item">
                                <label class="filter-label">
                                    <span class="oi oi-sort-ascending me-1"></span> Trier par
                                </label>
                                <select class="form-select" @bind="sortOrder" @bind:after="ApplyFilter">
                                    <option value="newest">Plus récentes</option>
                                    <option value="oldest">Plus anciennes</option>
                                    <option value="largest">Plus grandes</option>
                                    <option value="smallest">Plus petites</option>
                                </select>
                            </div>
                            <div class="filter-item filter-item-small">
                                <label class="filter-label">Vue</label>
                                <div class="btn-group w-100" role="group" aria-label="Vue">
                                    <button type="button"
                                            class="btn btn-sm @(viewMode == "grid" ? "btn-primary" : "btn-outline-primary")"
                                            @onclick="SetGridView">
                                        <span class="oi oi-grid-three-up"></span>
                                    </button>
                                    <button type="button"
                                            class="btn btn-sm @(viewMode == "large" ? "btn-primary" : "btn-outline-primary")"
                                            @onclick="SetLargeView">
                                        <span class="oi oi-grid-two-up"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Galerie de photos moderne -->
        <div class="row g-4 gallery-container">
            @foreach (var photo in filteredPhotos)
            {
                <div class="@(viewMode == "grid" ? "col-sm-6 col-md-4 col-lg-3" : "col-sm-6 col-lg-4")">
                    <div class="gallery-card" @onclick="() => SelectPhoto(photo)">
                        <div class="gallery-image-wrapper">
                            <img src="/api/photo/@photo.IdDonnee"
                                 class="gallery-image"
                                 alt="Photo du @photo.DateHeure.ToString("dd/MM/yyyy HH:mm")"
                                 loading="lazy"
                                 decoding="async">
                            <div class="gallery-overlay">
                                <div class="gallery-overlay-content">
                                    <span class="oi oi-fullscreen-enter gallery-zoom-icon"></span>
                                    <span class="gallery-view-text">Voir en grand</span>
                                </div>
                            </div>
                            <div class="gallery-time-badge">
                                <span class="oi oi-clock"></span>
                                @photo.DateHeure.ToString("HH:mm")
                            </div>
                        </div>
                        <div class="gallery-info">
                            <div class="gallery-info-header">
                                <div class="gallery-salle-badge">
                                    <span class="oi oi-home"></span>
                                    <span>Salle @photo.NoSalle</span>
                                </div>
                            </div>
                            <div class="gallery-info-row">
                                <span class="gallery-date">
                                    <span class="oi oi-calendar me-1"></span>
                                    @photo.DateHeure.ToString("dd MMM yyyy")
                                </span>
                                <span class="gallery-size">
                                    <span class="oi oi-file me-1"></span> @photo.TailleFormatee
                                </span>
                            </div>
                            @if (isAdmin)
                            {
                                <div class="gallery-actions">
                                    <a href="/api/photo/@photo.IdDonnee"
                                       download="photo_@(photo.IdDonnee)_@(photo.DateHeure.ToString("yyyyMMdd_HHmmss")).jpg"
                                       class="btn btn-sm btn-primary gallery-download-btn"
                                       @onclick:stopPropagation="true">
                                        <span class="oi oi-data-transfer-download me-1"></span> Télécharger
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Modal moderne pour afficher la photo en grand -->
@if (selectedPhoto != null)
{
    <div class="gallery-modal-backdrop" @onclick="CloseModal">
        <div class="gallery-modal" @onclick:stopPropagation="true">
            <button type="button" class="gallery-modal-close" @onclick="CloseModal" aria-label="Fermer">
                <span class="oi oi-x"></span>
            </button>

            <div class="gallery-modal-image-container">
                <img src="/api/photo/@selectedPhoto.IdDonnee"
                     class="gallery-modal-image"
                     alt="Photo du @selectedPhoto.DateHeure">
            </div>

            <div class="gallery-modal-info">
                <div class="gallery-modal-details">
                    <h5 class="gallery-modal-title">
                        <span class="oi oi-camera-slr me-2"></span>
                        Photo #@selectedPhoto.IdDonnee
                    </h5>
                    <div class="gallery-modal-meta">
                        <span class="gallery-modal-meta-item">
                            <span class="oi oi-calendar me-1"></span>
                            @selectedPhoto.DateHeure.ToString("dd MMMM yyyy")
                        </span>
                        <span class="gallery-modal-meta-item">
                            <span class="oi oi-clock me-1"></span>
                            @selectedPhoto.DateHeure.ToString("HH:mm:ss")
                        </span>
                        <span class="gallery-modal-meta-item">
                            <span class="oi oi-home me-1"></span>
                            Salle @selectedPhoto.NoSalle
                        </span>
                        <span class="gallery-modal-meta-item">
                            <span class="oi oi-file me-1"></span>
                            @selectedPhoto.TailleFormatee
                        </span>
                    </div>
                </div>
                <div class="gallery-modal-actions">
                    @if (isAdmin)
                    {
                        <a href="/api/photo/@selectedPhoto.IdDonnee"
                           download="photo_@(selectedPhoto.IdDonnee)_@(selectedPhoto.DateHeure.ToString("yyyyMMdd_HHmmss")).jpg"
                           class="btn btn-primary">
                            <span class="oi oi-data-transfer-download me-1"></span> Télécharger
                        </a>
                    }
                    <button type="button" class="btn btn-outline-secondary" @onclick="CloseModal">
                        <span class="oi oi-x me-1"></span> Fermer
                    </button>
                </div>
            </div>

            <!-- Navigation entre photos -->
            @if (filteredPhotos.Count > 1)
            {
                <button class="gallery-nav gallery-nav-prev" @onclick="PreviousPhoto" @onclick:stopPropagation="true" aria-label="Photo précédente">
                    <span class="oi oi-chevron-left"></span>
                </button>
                <button class="gallery-nav gallery-nav-next" @onclick="NextPhoto" @onclick:stopPropagation="true" aria-label="Photo suivante">
                    <span class="oi oi-chevron-right"></span>
                </button>
                <div class="gallery-counter">
                    @(filteredPhotos.IndexOf(selectedPhoto) + 1) / @filteredPhotos.Count
                </div>
            }
        </div>
    </div>
}

@code {
    private List<PhotoInfo> photos = new();
    private List<PhotoInfo> filteredPhotos = new();
    private List<int> salles = new();
    private PhotoInfo? selectedPhoto = null;
    private bool isLoading = true;
    private bool isRefreshing = false;
    private bool isAdmin = false;
    private string? errorMessage = null;
    private int selectedSalleFilter = 0;
    private string sortOrder = "newest";
    private string viewMode = "grid";

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRole();
        await LoadPhotos();
    }

    private async Task LoadUserRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var roleClaim = user.FindFirst(System.Security.Claims.ClaimTypes.Role);
            isAdmin = roleClaim?.Value == "Admin";
        }
    }

    private async Task LoadPhotos()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            photos = await PhotoService.GetAllPhotosAsync();

            // Extraire la liste unique des salles
            salles = photos.Select(p => p.NoSalle).Distinct().OrderBy(s => s).ToList();

            ApplyFilter();

            Logger.LogInformation($"Chargement de {photos.Count} photos réussi");
        }
        catch (Exception ex)
        {
            errorMessage = $"Impossible de charger les photos: {ex.Message}";
            Logger.LogError(ex, "Erreur lors du chargement des photos");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshPhotos()
    {
        isRefreshing = true;
        StateHasChanged();
        await LoadPhotos();
        isRefreshing = false;
    }

    private void OnSalleFilterChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int salleId))
        {
            selectedSalleFilter = salleId;
            ApplyFilter();
        }
    }

    private void ApplyFilter()
    {
        // Filtrer par salle
        var result = selectedSalleFilter == 0
            ? photos.AsEnumerable()
            : photos.Where(p => p.NoSalle == selectedSalleFilter);

        // Appliquer le tri
        filteredPhotos = sortOrder switch
        {
            "newest" => result.OrderByDescending(p => p.DateHeure).ToList(),
            "oldest" => result.OrderBy(p => p.DateHeure).ToList(),
            "largest" => result.OrderByDescending(p => p.TailleBytes).ToList(),
            "smallest" => result.OrderBy(p => p.TailleBytes).ToList(),
            _ => result.OrderByDescending(p => p.DateHeure).ToList()
        };
    }

    private void SetGridView() => viewMode = "grid";
    private void SetLargeView() => viewMode = "large";

    private void SelectPhoto(PhotoInfo photo)
    {
        selectedPhoto = photo;
    }

    private void CloseModal()
    {
        selectedPhoto = null;
    }

    private void PreviousPhoto()
    {
        if (selectedPhoto == null || filteredPhotos.Count <= 1) return;

        var currentIndex = filteredPhotos.IndexOf(selectedPhoto);
        var newIndex = currentIndex <= 0 ? filteredPhotos.Count - 1 : currentIndex - 1;
        selectedPhoto = filteredPhotos[newIndex];
    }

    private void NextPhoto()
    {
        if (selectedPhoto == null || filteredPhotos.Count <= 1) return;

        var currentIndex = filteredPhotos.IndexOf(selectedPhoto);
        var newIndex = currentIndex >= filteredPhotos.Count - 1 ? 0 : currentIndex + 1;
        selectedPhoto = filteredPhotos[newIndex];
    }
}
